{{ if not site.Config.Privacy.GoogleAnalytics.Disable }}
  {{- with site.Config.Services.GoogleAnalytics.ID }}
    {{- if strings.HasPrefix (lower .) "ua-" }}
      {{- warnf "Google Analytics 4 (GA4) replaced Google Universal Analytics (UA) effective 1 July 2023. See https://support.google.com/analytics/answer/11583528. Create a GA4 property and data stream, then replace the Google Analytics ID in your site configuration with the new value." }}
    {{- else }}
      <script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
      <script>
        function gasetup() {
            if (document.cookie.valueOf('eclipse_cookieconsent_status').search("allow") > -1 ) {
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', '{{ . }}');
            }
        }

        // Listen for changes to the cookie consent status
        // and re-run the GA setup if the user has accepted cookies
        // This is necessary otherwise we'll lose the first page view
        cookieStore.addEventListener('change', ({changed, deleted}) => {
          if (changed.find(({name}) => name === 'eclipse_cookieconsent_status')) {
            gasetup();
          }
        });

        gasetup();

      </script>
    {{- end }}
  {{- end }}
{{- end -}}
